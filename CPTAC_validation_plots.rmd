---
title: 'Analysis: CPTAC Validation'
author: 'F. Eduati'
date: '`r Sys.Date()`'
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE,
    include = TRUE
)
```

## Introduction 
Code used to validate the prognostic ability of our extracted spatial features in the independent cohort CPTAC. This notebook produces Figures 6B and C as shown in t.b.a. Bootstrapped models are provided in `data/bootstrap_model.RData`, full description of how these models were built can be found in t.b.a. 


## Setup
Load required libraries and load bootrap models. 
```{r, message=FALSE, warning=FALSE}
# Libraries
library(glmnet)
library(pROC)
library(PRROC)
library(ggplot2)
library(caret)

# load data
load(file = "data/bootstrap_model.RData")
```

## AUC-ROC Curve
```{r}
# make predictions on the CPTAC test set for each model
test_pred <- lapply(boot_models, function(x) {
    predict(x, newx = CPTAC_features, type = "response")
})
test_pred.df <- do.call(cbind, test_pred)
test_pred_median <- apply(test_pred.df, 1, median)
roc_res <- roc.glmnet(test_pred_median, newy = CPTAC_1yearsurv)
auc(roc(CPTAC_1yearsurv, test_pred_median))


ggplot(roc_res, aes(x = FPR, y = TPR)) +
    geom_line(color = "blue") +
    geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
    labs(title = "ROC Curve", x = "False Positive Rate", y = "True Positive Rate") +
    theme_minimal()
```

## Feature importance
```{r}
# convert to binary using the 0.5 threshold and compute performances
test_pred_median_binary <- ifelse(test_pred_median > 0.5, 1, 0)
confusionMatrix(as.factor(as.numeric(test_pred_median_binary)), as.factor(CPTAC_1yearsurv), positive = "1")

# retrieve robust coefficients (selected in more that 50% of the bootstrap runs)
nonzero_coeff <- lapply(boot_models, function(x) {
    model_coef <- coef(x)
    return(model_coef@Dimnames[[1]][model_coef@i + 1])
})
nonzero_coeff_sorted <- sort(table(unlist(nonzero_coeff)), decreasing = T)
recurrent_features <- setdiff(names(which(nonzero_coeff_sorted > 50)), "(Intercept)")

bootstrap_coeff <- lapply(boot_models, function(x) {
    model_coef <- coef(x)
    nonZeroFeat <- data.frame(names = model_coef@Dimnames[[1]][model_coef@i + 1], value = model_coef@x)

    ix <- match(recurrent_features, nonZeroFeat$names)
    coeff_value <- nonZeroFeat$value[ix]
    coeff_value[is.na(coeff_value)] <- 0
    return(coeff_value)
})

summary_coeff <- data.frame(
    name = recurrent_features,
    median = apply(do.call(cbind, bootstrap_coeff), 1, median),
    sd = apply(do.call(cbind, bootstrap_coeff), 1, sd)
)


ggplot(data = summary_coeff, aes(x = reorder(name, -median), y = median)) +
    geom_bar(stat = "identity") +
    labs(title = "Predictive spatial features", x = "Feature", y = "Estimated coefficient") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Session information
```{r session_info, echo=FALSE}
options(width = 120)
sessioninfo::session_info()
```